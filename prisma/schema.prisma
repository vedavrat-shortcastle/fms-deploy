generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// Federation Schema
model Federation {
  id      String  @id @default(uuid())
  name    String
  type    FedType
  country String
  domain  String  @unique // White-labeling domain
  logo    String?
  isApproved Boolean @default(false) @map("is_approved")

  // Relation Fix: Differentiate players and admins
  players User[] @relation(name: "FedPlayers")
  admins  User[] @relation(name: "FedAdmins")

  clubs         Club[]
  events        Event[]
  subscriptions Subscription[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("federation")
}

// Club Schema
model Club {
  id   String @id @default(uuid())
  name String

  // Relation Fix: Differentiate manager and players
  manager   User   @relation(name: "ClubManager", fields: [managerId], references: [id])
  managerId String @unique @map("manager_id")

  players User[] @relation(name: "ClubPlayers")

  federation   Federation @relation(fields: [federationId], references: [id])
  federationId String       @map("federation_id")

  createdAt DateTime @default(now()) @map("created_at")

  @@unique([name, federationId])
  @@map("club")
}

// User Schema
model User {
  id          String           @id @default(uuid())
  email       String
  password    String
  role        Role             @default(PLAYER)
  permissions UserPermission[]

  // Relation Fix: Reference named relations
  federation   Federation? @relation(name: "FedPlayers", fields: [federationId], references: [id])
  federationId String?       @map("federation_id")

  adminOf             Federation? @relation(name: "FedAdmins", fields: [adminFederationId], references: [id])
  adminFederationId String?       @map("admin_federation_id")

  club   Club?   @relation(name: "ClubPlayers", fields: [clubId], references: [id])
  clubId String? @map("club_id")

  managedClub Club? @relation(name: "ClubManager")

  // Personal Info
  firstName  String    @map("first_name")
  lastName   String    @map("last_name")
  middleName String?   @map("middle_name")
  nameSuffix String?   @map("name_suffix")
  birthDate  DateTime @map("birth_date")
  gender     Gender
  avatarUrl  String?   @map("avatar_url")
  ageProof   String?   @map("age_proof") // URL of uploaded age proof document

  // Mailing Details
  streetAddress  String @map("street_address")
  streetAddress2 String? @map("street_address2")
  country        String
  state          String
  city           String
  postalCode     String @map("postal_code")
  phoneNumber    String?  @map("phone_number")
  countryCode    String?  @map("country_code")

  // Other Info
  fideId         String?   @unique @map("fide_id")
  schoolName     String?   @map("school_name")
  graduationYear Int?      @map("graduation_year")
  gradeInSchool  String?   @map("grade_in_school")
  gradeDate      DateTime? @map("grade_date")
  clubName       String?   @map("club_name")
  isDisabled     Boolean   @default(false) @map("is_disabled")

  subscriptions Subscription[]
  createdAt     DateTime       @default(now()) @map("created_at")

  @@unique([email, federationId])
  @@map("user")
}

// Subscription Schema
model Subscription {
  id             String       @id @default(uuid())
  federation   Federation @relation(fields: [federationId], references: [id])
  federationId String       @map("federation_id")

  subscriber   User   @relation(fields: [subscriberId], references: [id])
  subscriberId String @map("subscriber_id")

  type      SubscriptionType
  status    SubscriptionStatus
  startDate DateTime           @map("start_date")
  endDate   DateTime           @map("end_date")
  createdAt DateTime           @default(now()) @map("created_at")

  @@map("subscription")
}

// Event Schema
model Event {
  id             String       @id @default(uuid())
  name           String
  description    String?
  image          String?
  video          String?
  mode           EventMode
  venue          String?
  startDate      DateTime     @map("start_date")
  startTime      String       @map("start_time")
  endDate        DateTime     @map("end_date")
  endTime        String       @map("end_time")
  contactInfo    ContactInfo  @relation(fields: [contactInfoId], references: [id])
  federation   Federation @relation(fields: [federationId], references: [id])
  federationId String       @map("federation_id")
  format         EventFormat
  numberOfRounds Int          @map("number_of_rounds")
  isRated        Boolean      @map("is_rated")
  timeControl    String?      @map("time_control")
  entryFees      EntryFee[]
  brochure       String? // URL to brochure (PDF/Image)
  aboutEvent     String?      @map("about_event") // Quill formatted content
  prizesAwards   String?      @map("prizes_awards") // Quill formatted content
  faq            String? // Quill formatted content
  createdAt      DateTime     @default(now()) @map("created_at")
  contactInfoId  String       @map("contact_info_id")

  @@map("event")
}

// Entry Fee Model
model EntryFee {
  id       String @id @default(uuid())
  event    Event  @relation(fields: [eventId], references: [id])
  eventId  String @map("event_id")
  category String // e.g., "Open", "Under 19", "Under 9"
  amount   Float
  currency String // e.g., "USD", "EUR"

  @@map("entry_fee")
}

// ContactInfo Embedded Model
model ContactInfo {
  id          String  @id @default(uuid())
  name        String
  phoneNumber String  @map("phone_number")
  email       String
  website     String?
  Event       Event[]

  @@map("contact_info")
}

// Enums
enum FedType {
  NATIONAL
  REGIONAL
}

enum Role {
  SUPER_ADMIN // Platform-wide admin
  FED_ADMIN // Federation-level admin
  CLUB_MANAGER // Manages a club
  PLAYER // Regular user
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum SubscriptionType {
  INDIVIDUAL
  EVENT
}

enum SubscriptionStatus {
  ACTIVE
  EXPIRED
  CANCELED
}

enum EventMode {
  ONLINE
  OFFLINE
}

enum EventFormat {
  SWISS
  QUAD
  TEAM
}

//
//***************************************************    RBAC SETUP    ***************************************************
//

model Permission {
  id          String           @id @default(uuid())
  name        String           @unique
  code        String           @unique
  description String?
  createdAt   DateTime         @default(now()) @map("created_at")
  updatedAt   DateTime         @default(now()) @map("updated_at")
  users       UserPermission[]

  @@map("permission")
}

model UserPermission {
  userId       String     @map("admin_user_id")
  permissionId String     @map("permission_id")
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @default(now()) @map("updated_at")
  user         User       @relation(fields: [userId], references: [id])
  permission   Permission @relation(fields: [permissionId], references: [id])

  @@id([userId, permissionId])
  @@map("user_permission")
}
